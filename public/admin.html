<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Tickets</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f4f6;
            color: #111827;
        }

        .admin-header {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters h2 {
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .filter-section {
            margin-bottom: 1rem;
        }

        .filter-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #6b7280;
        }

        .filter-select {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            min-width: 200px;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #2563eb;
            color: #2563eb;
        }

        .filter-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .tickets-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tickets-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-pendiente { background: #fef3c7; color: #92400e; }
        .badge-en_proceso { background: #dbeafe; color: #1e40af; }
        .badge-resuelto { background: #d1fae5; color: #065f46; }
        .badge-cerrado { background: #e5e7eb; color: #374151; }

        .badge-urgente { background: #fee2e2; color: #991b1b; }
        .badge-alta { background: #fed7aa; color: #9a3412; }
        .badge-media { background: #fef3c7; color: #92400e; }
        .badge-baja { background: #d1fae5; color: #065f46; }

        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-view { background: #3b82f6; color: white; }
        .btn-view:hover { background: #2563eb; }

        .btn-update { background: #10b981; color: white; }
        .btn-update:hover { background: #059669; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .detail-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .status-selector {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .status-selector select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            margin-top: 0.5rem;
        }

        .btn-update-status {
            width: 100%;
            padding: 0.75rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        .btn-update-status:hover {
            background: #059669;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }

        .notes-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .note-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            border-left: 3px solid #2563eb;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .note-text {
            color: #111827;
        }

        .add-note-form {
            margin-top: 1rem;
        }

        .add-note-form textarea {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            min-height: 80px;
        }

        .add-note-form input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .btn-add-note {
            width: 100%;
            padding: 0.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-add-note:hover {
            background: #1e40af;
        }

        .assignment-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fef3c7;
            border-radius: 8px;
        }

        .btn-export {
            padding: 0.75rem 1.5rem;
            background: #059669;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-export:hover {
            background: #047857;
        }

        .whatsapp-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #25d366, #128c7e);
            border-radius: 8px;
            color: white;
        }

        .whatsapp-section h3 {
            color: white;
            margin-bottom: 1rem;
        }

        .whatsapp-templates {
            display: grid;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .template-btn {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .template-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .btn-whatsapp {
            width: 100%;
            padding: 1rem;
            background: white;
            color: #128c7e;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .btn-whatsapp:hover {
            background: #f0f0f0;
        }

        .whatsapp-history {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .whatsapp-contact-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .btn-whatsapp-quick {
            padding: 0.5rem 1rem;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .btn-whatsapp-quick:hover {
            background: #128c7e;
        }

        .custom-message {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-bottom: 1rem;
            min-height: 80px;
            resize: vertical;
        }

        .custom-message::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Header Button */
        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Users Panel */
        .users-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .users-header {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .users-content {
            padding: 1.5rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .users-table th {
            background: #f3f4f6;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .users-table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-admin {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-tecnico {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .btn-edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-icon:hover {
            opacity: 0.8;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .toggle-whatsapp {
            background: white;
            color: #25D366;
            border: 2px solid #25D366;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-whatsapp:hover {
            background: #25D366;
            color: white;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1><i class="fas fa-tachometer-alt"></i> Panel de Administraci√≥n de Tickets</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button onclick="toggleUsersPanel()" class="header-btn">
                        <i class="fas fa-users"></i> Usuarios
                    </button>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Tickets</h3>
                <div class="number" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <h3>Pendientes</h3>
                <div class="number" id="stat-pendiente">0</div>
            </div>
            <div class="stat-card">
                <h3>En Proceso</h3>
                <div class="number" id="stat-en-proceso">0</div>
            </div>
            <div class="stat-card">
                <h3>Resueltos</h3>
                <div class="number" id="stat-resuelto">0</div>
            </div>
        </div>

        <!-- Users Panel -->
        <div class="users-panel" id="usersPanel" style="display: none;">
            <div class="users-header">
                <div>
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-users"></i> Gesti√≥n de Usuarios
                    </h2>
                </div>
                <div>
                    <button class="toggle-whatsapp" onclick="toggleUsersPanel()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
            <div class="users-content">
                <div class="filter-actions" style="margin-bottom: 1.5rem;">
                    <button class="btn-primary" onclick="showUserForm()">
                        <i class="fas fa-plus"></i> Nuevo Usuario
                    </button>
                </div>

                <!-- User Form (hidden by default) -->
                <div id="userFormContainer" style="display: none; background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 id="formTitle">Nuevo Usuario</h3>
                    <form id="userForm" onsubmit="saveUser(event)">
                        <input type="hidden" id="userId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="username">Usuario *</label>
                                <input type="text" id="username" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Contrase√±a *</label>
                                <input type="password" id="password">
                                <small style="color: #6b7280;">Dejar vac√≠o para no cambiar</small>
                            </div>
                            <div class="form-group">
                                <label for="nombreCompleto">Nombre Completo</label>
                                <input type="text" id="nombreCompleto">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email">
                            </div>
                            <div class="form-group">
                                <label for="rol">Rol *</label>
                                <select id="rol" required>
                                    <option value="tecnico">T√©cnico</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="activo">Estado *</label>
                                <select id="activo" required>
                                    <option value="1">Activo</option>
                                    <option value="0">Inactivo</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button type="button" class="btn-secondary" onclick="cancelUserForm()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Users Table -->
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>√öltimo Acceso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">
                                Cargando usuarios...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h2>Filtrar Tickets</h2>
            <div class="filter-section">
                <label>Estado:</label>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="todos">Todos</button>
                    <button class="filter-btn" data-filter="pendiente">Pendientes</button>
                    <button class="filter-btn" data-filter="en_proceso">En Proceso</button>
                    <button class="filter-btn" data-filter="resuelto">Resueltos</button>
                    <button class="filter-btn" data-filter="cerrado">Cerrados</button>
                </div>
            </div>
            <div class="filter-section">
                <label>Servicio:</label>
                <select class="filter-select" id="filterServicio">
                    <option value="todos">Todos los servicios</option>
                    <option value="reparacion">Reparaci√≥n de Equipos</option>
                    <option value="redes">Montaje de Redes</option>
                    <option value="impresoras">Soporte de Impresoras</option>
                    <option value="seguridad">Seguridad Inform√°tica</option>
                    <option value="errores">Detecci√≥n de Errores</option>
                    <option value="soporte">Soporte T√©cnico General</option>
                    <option value="desarrollo_app">Programaci√≥n de Aplicaciones Personalizadas</option>
                    <option value="desarrollo_web">Desarrollo de Entornos Web</option>
                </select>
            </div>
            <div class="filter-section">
                <label>Prioridad:</label>
                <select class="filter-select" id="filterPrioridad">
                    <option value="todos">Todas las prioridades</option>
                    <option value="urgente">Urgente</option>
                    <option value="alta">Alta</option>
                    <option value="media">Media</option>
                    <option value="baja">Baja</option>
                </select>
            </div>
        </div>

        <!-- Tickets Table -->
        <div class="tickets-container">
            <div class="tickets-header">
                <h2>Lista de Tickets</h2>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-export" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> Exportar CSV
                    </button>
                    <input type="text" class="search-box" id="searchBox" placeholder="Buscar tickets...">
                </div>
            </div>
            <div id="ticketsTableContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p>Cargando tickets...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for ticket details -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalles del Ticket</h2>
                <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="ticketDetails"></div>
        </div>
    </div>

    <script>
        let allTickets = [];
        let filteredTickets = [];
        let currentFilter = 'todos';
        let currentServicioFilter = 'todos';
        let currentPrioridadFilter = 'todos';

        // Load tickets on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTickets();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    filterTickets();
                });
            });

            // Servicio filter
            document.getElementById('filterServicio').addEventListener('change', (e) => {
                currentServicioFilter = e.target.value;
                filterTickets();
            });

            // Prioridad filter
            document.getElementById('filterPrioridad').addEventListener('change', (e) => {
                currentPrioridadFilter = e.target.value;
                filterTickets();
            });

            // Search box
            document.getElementById('searchBox').addEventListener('input', (e) => {
                searchTickets(e.target.value);
            });
        }

        async function loadTickets() {
            try {
                const response = await fetch('/api/tickets');
                
                // Verificar si la sesi√≥n expir√≥
                if (response.status === 401) {
                    alert('Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                    window.location.href = '/login';
                    return;
                }
                
                allTickets = await response.json();
                updateStatistics();
                filterTickets();
            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsTableContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error al cargar los tickets</p>
                    </div>
                `;
            }
        }

        function updateStatistics() {
            document.getElementById('stat-total').textContent = allTickets.length;
            document.getElementById('stat-pendiente').textContent = 
                allTickets.filter(t => t.estado === 'pendiente').length;
            document.getElementById('stat-en-proceso').textContent = 
                allTickets.filter(t => t.estado === 'en_proceso').length;
            document.getElementById('stat-resuelto').textContent = 
                allTickets.filter(t => t.estado === 'resuelto').length;
        }

        function filterTickets() {
            filteredTickets = allTickets;
            
            // Filter by status
            if (currentFilter !== 'todos') {
                filteredTickets = filteredTickets.filter(t => t.estado === currentFilter);
            }
            
            // Filter by service
            if (currentServicioFilter !== 'todos') {
                filteredTickets = filteredTickets.filter(t => t.servicio === currentServicioFilter);
            }
            
            // Filter by priority
            if (currentPrioridadFilter !== 'todos') {
                filteredTickets = filteredTickets.filter(t => t.prioridad === currentPrioridadFilter);
            }
            
            renderTicketsTable();
        }

        function searchTickets(query) {
            const lowerQuery = query.toLowerCase();
            filteredTickets = allTickets.filter(t => 
                t.ticket_id.toLowerCase().includes(lowerQuery) ||
                t.nombre.toLowerCase().includes(lowerQuery) ||
                t.email.toLowerCase().includes(lowerQuery) ||
                t.descripcion.toLowerCase().includes(lowerQuery)
            );
            renderTicketsTable();
        }

        function renderTicketsTable() {
            const container = document.getElementById('ticketsTableContainer');
            
            if (filteredTickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No hay tickets para mostrar</p>
                    </div>
                `;
                return;
            }

            const servicios = {
                'reparacion': 'Reparaci√≥n',
                'redes': 'Redes',
                'impresoras': 'Impresoras',
                'seguridad': 'Seguridad',
                'errores': 'Errores',
                'soporte': 'Soporte'
            };

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTickets.map(ticket => `
                            <tr>
                                <td><strong>${ticket.ticket_id}</strong></td>
                                <td>
                                    ${ticket.nombre}
                                    ${ticket.tecnico_asignado ? `<br><small style="color: #2563eb;"><i class="fas fa-user"></i> ${ticket.tecnico_asignado}</small>` : ''}
                                </td>
                                <td>${servicios[ticket.servicio] || ticket.servicio}</td>
                                <td><span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span></td>
                                <td><span class="badge badge-${ticket.estado}">${ticket.estado.replace('_', ' ')}</span></td>
                                <td>${new Date(ticket.fecha_creacion).toLocaleDateString('es-ES')}</td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn-small btn-view" onclick="viewTicket('${ticket.ticket_id}')">
                                            <i class="fas fa-eye"></i> Ver
                                        </button>
                                        <button class="btn-whatsapp-quick" onclick="openWhatsApp('${ticket.telefono}', '${ticket.ticket_id}', '${ticket.nombre}')">
                                            <i class="fab fa-whatsapp"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        async function viewTicket(ticketId) {
            try {
                const [ticketResponse, notesResponse, whatsappResponse] = await Promise.all([
                    fetch(`/api/tickets/${ticketId}`),
                    fetch(`/api/tickets/${ticketId}/notes`),
                    fetch(`/api/tickets/${ticketId}/whatsapp`)
                ]);
                
                const ticket = await ticketResponse.json();
                const notes = await notesResponse.json();
                const whatsappContacts = await whatsappResponse.json();
                
                const servicios = {
                    'reparacion': 'Reparaci√≥n de Equipos',
                    'redes': 'Montaje de Redes',
                    'impresoras': 'Soporte de Impresoras',
                    'seguridad': 'Seguridad Inform√°tica',
                    'errores': 'Detecci√≥n de Errores',
                    'soporte': 'Soporte T√©cnico General',
                    'desarrollo_app': 'Programaci√≥n de Aplicaciones Personalizadas',
                    'desarrollo_web': 'Desarrollo de Entornos Web'
                };

                const notesHtml = notes.length > 0 ? notes.map(note => `
                    <div class="note-item">
                        <div class="note-header">
                            <strong>${note.autor}</strong>
                            <span>${new Date(note.fecha_creacion).toLocaleString('es-ES')}</span>
                        </div>
                        <div class="note-text">${note.nota}</div>
                    </div>
                `).join('') : '<p style="color: #6b7280;">No hay notas a√∫n</p>';

                const whatsappHistoryHtml = whatsappContacts.length > 0 ? whatsappContacts.map(contact => `
                    <div class="whatsapp-contact-item">
                        <strong>${contact.enviado_por}</strong> contact√≥ al cliente
                        ${contact.mensaje ? `<br>Mensaje: "${contact.mensaje}"` : ''}
                        <br><small>${new Date(contact.fecha_contacto).toLocaleString('es-ES')}</small>
                    </div>
                `).join('') : '<p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">No hay contactos previos</p>';

                document.getElementById('ticketDetails').innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Ticket ID</div>
                        <div><strong>${ticket.ticket_id}</strong></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Cliente</div>
                        <div>${ticket.nombre}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email</div>
                        <div>${ticket.email}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Tel√©fono</div>
                        <div>${ticket.telefono}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Servicio</div>
                        <div>${servicios[ticket.servicio]}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Prioridad</div>
                        <div><span class="badge badge-${ticket.prioridad}">${ticket.prioridad}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Descripci√≥n</div>
                        <div>${ticket.descripcion}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Fecha de Creaci√≥n</div>
                        <div>${new Date(ticket.fecha_creacion).toLocaleString('es-ES')}</div>
                    </div>

                    <div class="whatsapp-section">
                        <h3><i class="fab fa-whatsapp"></i> Contactar por WhatsApp</h3>
                        <div class="whatsapp-templates">
                            <button class="template-btn" onclick="setWhatsAppMessage('Hola ${ticket.nombre}, somos del servicio t√©cnico. Hemos recibido tu solicitud ${ticket.ticket_id} sobre ${servicios[ticket.servicio]}. ¬øEn qu√© momento podemos visitarte?')">
                                üìÖ Solicitar visita
                            </button>
                            <button class="template-btn" onclick="setWhatsAppMessage('Hola ${ticket.nombre}, te informamos que estamos trabajando en tu caso ${ticket.ticket_id}. Te mantendremos informado del progreso.')">
                                üîß Actualizaci√≥n de estado
                            </button>
                            <button class="template-btn" onclick="setWhatsAppMessage('Hola ${ticket.nombre}, tu caso ${ticket.ticket_id} ha sido resuelto. ¬øPodr√≠as confirmar que todo funciona correctamente?')">
                                ‚úÖ Caso resuelto
                            </button>
                            <button class="template-btn" onclick="setWhatsAppMessage('Hola ${ticket.nombre}, necesitamos m√°s informaci√≥n sobre tu caso ${ticket.ticket_id}. ¬øPodr√≠as proporcionarnos m√°s detalles?')">
                                ‚ÑπÔ∏è Solicitar informaci√≥n
                            </button>
                        </div>
                        <textarea class="custom-message" id="whatsappMessage" placeholder="Escribe un mensaje personalizado o selecciona una plantilla..."></textarea>
                        <input type="text" id="tecnicoWhatsApp" placeholder="Tu nombre (t√©cnico)" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 5px; background: rgba(255,255,255,0.2); color: white; margin-bottom: 1rem;">
                        <button class="btn-whatsapp" onclick="sendWhatsApp('${ticket.telefono}', '${ticket.ticket_id}', '${ticket.nombre}')">
                            <i class="fab fa-whatsapp"></i> Abrir WhatsApp y Enviar Mensaje
                        </button>
                        <div class="whatsapp-history">
                            <strong>Historial de Contactos:</strong>
                            <div style="margin-top: 0.5rem;">
                                ${whatsappHistoryHtml}
                            </div>
                        </div>
                    </div>
                    
                    <div class="assignment-section">
                        <div class="detail-label"><i class="fas fa-user"></i> Asignar T√©cnico</div>
                        <input type="text" id="tecnicoInput" placeholder="Nombre del t√©cnico" value="${ticket.tecnico_asignado || ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 5px; margin-top: 0.5rem;">
                        <button class="btn-update-status" onclick="assignTechnicianToTicket('${ticket.ticket_id}')" style="background: #f59e0b; margin-top: 0.5rem;">
                            <i class="fas fa-user-check"></i> Asignar T√©cnico
                        </button>
                    </div>

                    <div class="notes-section">
                        <h3><i class="fas fa-comment"></i> Notas Internas</h3>
                        <div style="max-height: 300px; overflow-y: auto; margin-top: 1rem;">
                            ${notesHtml}
                        </div>
                        <div class="add-note-form">
                            <input type="text" id="autorNota" placeholder="Tu nombre" style="width: 100%;">
                            <textarea id="nuevaNota" placeholder="Escribe una nota interna..."></textarea>
                            <button class="btn-add-note" onclick="addNote('${ticket.ticket_id}')">
                                <i class="fas fa-plus"></i> A√±adir Nota
                            </button>
                        </div>
                    </div>
                    
                    <div class="status-selector">
                        <div class="detail-label">Actualizar Estado</div>
                        <select id="statusSelect">
                            <option value="pendiente" ${ticket.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="en_proceso" ${ticket.estado === 'en_proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="resuelto" ${ticket.estado === 'resuelto' ? 'selected' : ''}>Resuelto</option>
                            <option value="cerrado" ${ticket.estado === 'cerrado' ? 'selected' : ''}>Cerrado</option>
                        </select>
                        <button class="btn-update-status" onclick="updateTicketStatus('${ticket.ticket_id}')">
                            <i class="fas fa-save"></i> Actualizar Estado
                        </button>
                    </div>
                `;
                
                document.getElementById('ticketModal').classList.add('active');
            } catch (error) {
                console.error('Error loading ticket details:', error);
            }
        }

        async function updateTicketStatus(ticketId) {
            const newStatus = document.getElementById('statusSelect').value;
            
            try {
                const response = await fetch(`/api/tickets/${ticketId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado: newStatus })
                });

                if (response.ok) {
                    alert('Estado actualizado correctamente');
                    closeModal();
                    loadTickets();
                } else {
                    alert('Error al actualizar el estado');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error al actualizar el estado');
            }
        }

        function closeModal() {
            document.getElementById('ticketModal').classList.remove('active');
        }

        async function addNote(ticketId) {
            const nota = document.getElementById('nuevaNota').value;
            const autor = document.getElementById('autorNota').value;
            
            if (!nota || !autor) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            try {
                const response = await fetch(`/api/tickets/${ticketId}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nota, autor })
                });
                
                if (response.ok) {
                    viewTicket(ticketId); // Reload ticket to show new note
                } else {
                    alert('Error al a√±adir nota');
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Error al a√±adir nota');
            }
        }

        async function assignTechnicianToTicket(ticketId) {
            const tecnico = document.getElementById('tecnicoInput').value;
            
            if (!tecnico) {
                alert('Por favor ingresa el nombre del t√©cnico');
                return;
            }
            
            try {
                const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tecnico })
                });
                
                if (response.ok) {
                    alert('T√©cnico asignado correctamente');
                    closeModal();
                    loadTickets();
                } else {
                    alert('Error al asignar t√©cnico');
                }
            } catch (error) {
                console.error('Error assigning technician:', error);
                alert('Error al asignar t√©cnico');
            }
        }

        function exportToCSV() {
            if (filteredTickets.length === 0) {
                alert('No hay tickets para exportar');
                return;
            }

            const servicios = {
                'reparacion': 'Reparaci√≥n de Equipos',
                'redes': 'Montaje de Redes',
                'impresoras': 'Soporte de Impresoras',
                'seguridad': 'Seguridad Inform√°tica',
                'errores': 'Detecci√≥n de Errores',
                'soporte': 'Soporte T√©cnico General',
                'desarrollo_app': 'Programaci√≥n de Aplicaciones Personalizadas',
                'desarrollo_web': 'Desarrollo de Entornos Web'
            };

            const headers = ['Ticket ID', 'Cliente', 'Email', 'Tel√©fono', 'Servicio', 'Prioridad', 'Estado', 'T√©cnico Asignado', 'Descripci√≥n', 'Fecha'];
            const rows = filteredTickets.map(ticket => [
                ticket.ticket_id,
                ticket.nombre,
                ticket.email,
                ticket.telefono,
                servicios[ticket.servicio] || ticket.servicio,
                ticket.prioridad,
                ticket.estado,
                ticket.tecnico_asignado || 'No asignado',
                ticket.descripcion.replace(/,/g, ';'),
                new Date(ticket.fecha_creacion).toLocaleString('es-ES')
            ]);

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `tickets_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function setWhatsAppMessage(message) {
            document.getElementById('whatsappMessage').value = message;
        }

        function formatPhoneNumber(phone) {
            // Remove all non-numeric characters
            let cleaned = phone.replace(/\D/g, '');
            
            // If starts with 0, assume it's a national number and add country code
            if (cleaned.startsWith('0')) {
                cleaned = '34' + cleaned.substring(1); // Spain country code
            }
            
            // If doesn't start with country code, add Spain code
            if (!cleaned.startsWith('34') && cleaned.length < 11) {
                cleaned = '34' + cleaned;
            }
            
            return cleaned;
        }

        async function sendWhatsApp(phone, ticketId, clientName) {
            const message = document.getElementById('whatsappMessage').value;
            const tecnico = document.getElementById('tecnicoWhatsApp').value;
            
            if (!tecnico) {
                alert('Por favor ingresa tu nombre');
                return;
            }

            const formattedPhone = formatPhoneNumber(phone);
            const encodedMessage = encodeURIComponent(message || `Hola ${clientName}, te contacto por tu ticket ${ticketId}.`);
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            
            // Register contact in database
            try {
                await fetch(`/api/tickets/${ticketId}/whatsapp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        telefono: phone, 
                        mensaje: message || `Hola ${clientName}, te contacto por tu ticket ${ticketId}.`,
                        enviado_por: tecnico 
                    })
                });
            } catch (error) {
                console.error('Error registering WhatsApp contact:', error);
            }
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Reload ticket to show new contact
            setTimeout(() => viewTicket(ticketId), 1000);
        }

        function openWhatsApp(phone, ticketId, clientName) {
            const formattedPhone = formatPhoneNumber(phone);
            const message = `Hola ${clientName}, te contacto por tu ticket ${ticketId}. ¬øEn qu√© puedo ayudarte?`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Auto-refresh every 30 seconds
        setInterval(loadTickets, 30000);

        // Logout function
        async function logout() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                try {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Error al cerrar sesi√≥n:', error);
                    window.location.href = '/login';
                }
            }
        }

        // ==================== GESTI√ìN DE USUARIOS ====================

        // ==================== GESTI√ìN DE USUARIOS ====================

        function toggleUsersPanel() {
            const panel = document.getElementById('usersPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                loadUsers();
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/usuarios');
                const users = await response.json();
                
                const tbody = document.getElementById('usersTableBody');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">
                                No hay usuarios registrados
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.nombre_completo || '-'}</td>
                        <td>${user.email || '-'}</td>
                        <td>
                            <span class="badge badge-${user.rol === 'admin' ? 'admin' : 'tecnico'}">
                                ${user.rol === 'admin' ? 'Administrador' : 'T√©cnico'}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-${user.activo ? 'active' : 'inactive'}">
                                ${user.activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>${user.ultimo_acceso ? new Date(user.ultimo_acceso).toLocaleString('es-ES') : 'Nunca'}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn-icon btn-edit" onclick="editUser(${user.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteUser(${user.id}, '${user.username}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                alert('Error al cargar usuarios');
            }
        }

        function showUserForm(user = null) {
            const container = document.getElementById('userFormContainer');
            const form = document.getElementById('userForm');
            const title = document.getElementById('formTitle');
            
            container.style.display = 'block';
            
            if (user) {
                title.textContent = 'Editar Usuario';
                document.getElementById('userId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('username').disabled = true;
                document.getElementById('password').value = '';
                document.getElementById('password').required = false;
                document.getElementById('nombreCompleto').value = user.nombre_completo || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('rol').value = user.rol;
                document.getElementById('activo').value = user.activo;
            } else {
                title.textContent = 'Nuevo Usuario';
                form.reset();
                document.getElementById('username').disabled = false;
                document.getElementById('password').required = true;
                document.getElementById('activo').value = '1';
                document.getElementById('rol').value = 'tecnico';
            }
        }

        function cancelUserForm() {
            document.getElementById('userFormContainer').style.display = 'none';
            document.getElementById('userForm').reset();
        }

        async function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                nombre_completo: document.getElementById('nombreCompleto').value,
                email: document.getElementById('email').value,
                rol: document.getElementById('rol').value,
                activo: parseInt(document.getElementById('activo').value)
            };
            
            // Si no hay contrase√±a en edici√≥n, no enviarla
            if (userId && !data.password) {
                delete data.password;
            }
            
            try {
                const url = userId ? `/api/usuarios/${userId}` : '/api/usuarios';
                const method = userId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Usuario guardado exitosamente');
                    cancelUserForm();
                    loadUsers();
                } else {
                    alert(result.error || 'Error al guardar usuario');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar usuario');
            }
        }

        async function editUser(id) {
            try {
                const response = await fetch('/api/usuarios');
                const users = await response.json();
                const user = users.find(u => u.id === id);
                
                if (user) {
                    showUserForm(user);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar usuario');
            }
        }

        async function deleteUser(id, username) {
            if (!confirm(`¬øEst√°s seguro de eliminar al usuario "${username}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/usuarios/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Usuario eliminado exitosamente');
                    loadUsers();
                } else {
                    alert(result.error || 'Error al eliminar usuario');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar usuario');
            }
        }
    </script>
</body>
</html>
